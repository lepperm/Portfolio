# Using local node image to build the React app
image: node:12.18.0

# Announce the URL as per CRA docs
# https://create-react-app.dev/docs/advanced-configuration/
variables:
  PUBLIC_URL: /portfolio
  FULL_URL: "https://maxlepper.gitlab.io/portfolio/"

# Name the stages involved in the pipeline
stages:
  - install
  - build
  - quality
  - deploy
  - audit

install:
  stage: install
  script:
    - echo "Installing dependencies"
    - npm install # Install all dependencies
  artifacts:
    name: "artifacts"
    untracked: true
    expire_in: 60 mins
    paths:
      - node_modules/

build:
  stage: build
  script:
    - echo "Building"
    - CI=false npm run build #  CI=false will allow our build to complete with warnings
  artifacts:
    paths:
      - build
    expire_in: 60 mins
  dependencies:
    - install # Passes in artifacts from "install" stage

quality:lint:
  stage: quality
  script:
    - echo "Linting to be performed here eventually"
  dependencies:
    - install
  needs: ["install"] # Allows linting to begin running as soon as dependencies are installed
  allow_failure: true

quality:jest:
  stage: quality
  script:
    - echo "Running tests"
    # CI=true will tell Jest to not run in watch mode
    # --env=jsdom provides a mock browser environment for testing
    # --coverage generates a human-readable summary of testing
    # --watchAll=false should force tests to run once, if CI=true doesn't
    - CI=true npm test -- --env=jsdom --coverage --watchAll=false
  dependencies:
    - install
  needs: ["install"] # Allows testing to begin running as soon as dependencies are installed
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  # Extracts the final overall coverage percentage. Also configured in gitlab for history
  allow_failure: true

# Job name for gitlab to recognise this results in assets for Gitlab Pages
# https://docs.gitlab.com/ee/user/project/pages/introduction.html#gitlab-pages-requirements
pages:
  stage: deploy
  script:
    - echo "Deploying Build to Public"
    - rm -rf public # Remove the existing public folder
    - mv build public # Move build files to public dir for Gitlab Pages
  after_script:
    - echo "Deployment successful, great work!"
  artifacts:
    paths:
      - public # The built files for Gitlab Pages to serve
  only:
    - master

# Manually conduct lighthouse audit
lighthouse:
  image: markhobson/node-chrome
  stage: audit
  before_script:
    - npm i -g lighthouse
  script:
    - lighthouse --chrome-flags="--headless --no-sandbox" $FULL_URL --output html --output-path ./report.html
  artifacts:
    paths:
      - ./report.html
    expire_in: 1 week
  when: manual
